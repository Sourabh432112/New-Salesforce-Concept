// publish plarform event using trigger
trigger CaseTrigger on Case (after update) {
    List<Case_Update__e> listOfEvents = new List<Case_Update__e>();
    for(Case caseRec :trigger.new){
        Case oldCase = trigger.oldMap.get(caseRec.Id);
        if(caseRec.Priority != oldCase.Priority){
            Case_Update__e event = new Case_Update__e();
            event.CaseId__c = caseRec.Id;
            event.ChangeType__c = 'Priority Change';
            event.Message__c  = 'prioriy is chagd';
            listOfEvents.add(event);
        }
    }
    if(!listOfEvents.isEmpty()){
        EventBus.publish(listOfEvents);
    }
}


// this code is used to subscribe platform event and refresh the componenet with updated data

import { LightningElement,wire,api } from 'lwc';
import getCaseRecord from '@salesforce/apex/CaseService.getCaseRecord';
import { subscribe, unsubscribe } from 'lightning/empApi';
import { refreshApex } from '@salesforce/apex';

export default class CaseRealTimeUI extends LightningElement {
    wiredCase;
    @api recordId;
    channelName = '/event/Case_Update__e';
    subscription = null;
    caseData;


    @wire(getCaseRecord, { caseId: '$recordId' })
        wiredCase(result) {
            this.wiredCase = result;  // VERY IMPORTANT
            const { data, error } = result;
            if(data){
                console.log('data---',data);
                this.caseData = data;
                console.log('wiredCase---',this.wiredCase);
            }
            if(error){
                console.log('error---',error);
            }
        }  

    connectedCallback(){
        console.log('connectedCallback---');
        this.subScribeEvent();
    }
    
    subScribeEvent() {
        subscribe(this.channelName, -1, (eventReceived) => {
            const caseIdFromEvent = eventReceived.data.payload.CaseId__c;

            if (caseIdFromEvent === this.recordId) {
                console.log('Refreshing case...');
                refreshApex(this.wiredCase); // ðŸ”¥ Correct refresh
            }
        })
        .then(response => {
            this.subscription = response;
            console.log('Subscribed:', JSON.stringify(response));
        })
        .catch(error => {
            console.error('Subscription error:', error);
        });
    }

}

<template>
     <lightning-card title="Case Details (Live)">
        <template if:true={caseData}>
            <p>Case Number: {caseData.CaseNumber}</p>
            <p>Status: {caseData.Status}</p>
            <p>Priority: {caseData.Priority}</p>
            <p>Subject: {caseData.Subject}</p>
        </template>
    </lightning-card>
</template>
